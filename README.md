# LINE_Group_Remind
LINEグループにて、特定のユーザーの発言から24時間経過しても返信が無い場合、リマインドを送信する。

## 概要

このGoogle Apps Script (GAS) は、特定のLINEグループまたはルームにおいて、指定されたユーザーが最後に発言してから一定時間（デフォルト24時間）応答がない場合に、自動でリマインドメッセージを送信するBotです。

## 機能

*   特定のLINEグループまたはルームを監視対象として設定可能。
*   監視対象グループ/ルーム内で、特定のユーザーの発言をトリガーとします。
*   監視対象ユーザーが発言後、設定された時間（デフォルト24時間）が経過しても次の発言がない場合、グループ/ルームに「リマインド」という固定メッセージを送信します。
*   設定値（チャネルアクセストークン、対象チャットID、監視対象ユーザーID）は全てスクリプトプロパティで管理します。

## 必要なもの

1.  **Googleアカウント**: Google Apps Scriptを利用するために必要です。
2.  **LINE Developersアカウント**: LINE Messaging APIを利用するために必要です。
    *   Messaging APIチャネルが作成済みであること。
    *   チャネルアクセストークン（長期）が発行済みであること。
3.  **監視したいLINEグループ/ルームのID**: グループIDまたはルームID。
4.  **監視したいLINEユーザーのID**: ユーザーID。

## セットアップ手順

### 1. Google Apps Scriptプロジェクトの準備

1.  Google Driveを開き、「新規」 > 「その他」 > 「Google Apps Script」を選択して新しいプロジェクトを作成します。
2.  プロジェクトに名前を付けます（例: `LineReminderBot`）。
3.  デフォルトで表示される `コード.gs` の内容を全て削除し、提供されたGASスクリプトの内容を貼り付けます。
4.  `ファイル` > `保存` でスクリプトを保存します。

### 2. スクリプトプロパティの設定

1.  スクリプトエディタの左側メニューから「プロジェクトの設定」（歯車アイコン）を開きます。
2.  「スクリプトプロパティ」セクションで、「スクリプト プロパティを追加」をクリックし、以下の3つのプロパティを設定します。

    | プロパティ (キー)                     | 値                                                                 | 説明                                                              |
    | :------------------------------------ | :----------------------------------------------------------------- | :---------------------------------------------------------------- |
    | `LINE_CHANNEL_ACCESS_TOKEN`           | `YOUR_CHANNEL_ACCESS_TOKEN`                                        | LINE Messaging APIのチャネルアクセストークン（長期）をここに貼り付けます。 |
    | `TARGET_CHAT_ID`                      | `YOUR_GROUP_OR_ROOM_ID`                                            | 監視したいLINEグループのID (`Cxxxxxxxx...`) またはルームID (`Rxxxxxxxx...`)。 |
    | `MONITORED_USER_ID`                   | `USER_ID_TO_MONITOR`                                               | 発言を監視するユーザーのLINEユーザーID (`Uxxxxxxxx...`)。             |

    *   **LINEグループ/ルームIDの取得方法**:
        *   LINE Botを対象のグループ/ルームに追加後、そのグループ/ルームでBotに何か話しかけます。
        *   LINE Developersコンソールのチャネル設定 > Messaging API設定 > Webhook URL に一時的なWebhook（例: RequestBinなど）を設定し、送信されてくるJSONペイロードから `source.groupId` または `source.roomId` を確認します。
    *   **ユーザーIDの取得方法**:
        *   監視したいユーザーがBotに個人チャットで話しかけるか、Botがいるグループ/ルームで発言した際のイベントから `source.userId` を確認します。

### 3. スクリプトのデプロイ (Webhook URLの取得)

1.  スクリプトエディタ右上の「デプロイ」ボタンをクリックし、「新しいデプロイ」を選択します。
2.  「種類の選択」で「ウェブアプリ」を選択します。
3.  以下の設定を行います。
    *   **説明**: (任意、例: `LINE Reminder Bot v1`)
    *   **次のユーザーとして実行**: `自分`
    *   **アクセスできるユーザー**: `全員`
4.  「デプロイ」をクリックします。
5.  初回デプロイ時には「承認が必要です」というダイアログが表示されるので、「アクセスを承認」をクリックし、ご自身のGoogleアカウントを選択して許可します。
    *   「このアプリは Google で確認されていません」と表示された場合は、「詳細」をクリックし、「（プロジェクト名）に移動（安全ではありません）」をクリックして進めてください。
6.  デプロイが完了すると、「ウェブアプリのURL」が表示されます。**このURLをコピーしておきます。** これがLINE Developersコンソールに設定するWebhook URLになります。
7.  「完了」をクリックします。

    **注意:** スクリプトを更新した場合は、再度「デプロイ」 > 「デプロイを管理」 > 対象のデプロイを選択し、鉛筆アイコン（編集） > 「新しいバージョン」を選択してデプロイし直す必要があります。ウェブアプリのURLは基本的に変わりませんが、設定変更を反映させるためには再デプロイが必要です。

### 4. LINE DevelopersコンソールでのWebhook設定

1.  [LINE Developersコンソール](https://developers.line.biz/console/)にログインします。
2.  対象のMessaging APIチャネルを選択します。
3.  「Messaging API設定」タブを開きます。
4.  「Webhook URL」の「編集」ボタンをクリックし、手順3でコピーした**ウェブアプリのURL**を貼り付けます。
5.  「Webhookの利用」をオン（緑色）にします。
6.  「更新」ボタンをクリックして保存します。
    *   「検証」ボタンが表示されている場合はクリックして、Webhook URLが正しく疎通できるか確認してください（GAS側で`doPost`が実行され、HTTP 200が返れば成功です）。
7.  **【重要】Webhookの再送設定:**
    *   Webhook URL設定の下に「エラー統計」や「再送設定」といった項目がある場合があります。
    *   **「Webhookの再送」機能は必ずオフ（無効）にしてください。**
    *   このスクリプトは、受信したイベントIDに基づいて処理の重複を避けるような設計にはなっていません。Webhookの再送がオンになっていると、GAS側で一時的なエラー（タイムアウト、GASの同時実行数上限など）が発生した場合にLINEプラットフォームが同じイベントを再送し、それによってBotが意図せず複数回同じリマインダー処理を開始したり、無限ループのようにメッセージを送信し続けてしまう可能性があります。**意図しない大量送信やAPI制限超過を防ぐため、再送は必ずオフにしてください。**

### 5. トリガーの設定

リマインダーのチェックを定期的に行うためのトリガーを設定します。

1.  GASスクリプトエディタの左側メニューから「トリガー」（時計アイコン）を開きます。
2.  右下の「トリガーを追加」ボタンをクリックします。
3.  以下の通り設定します。
    *   **実行する関数を選択**: `checkAndSendReminders`
    *   **実行するデプロイを選択**: `Head` (または最新のデプロイID)
    *   **イベントのソースを選択**: `時間主導型`
    *   **時間ベースのトリガーのタイプを選択**: `分ベースのタイマー`
    *   **時間の間隔を選択（分）**: `1分おき` (または任意の短い間隔。推奨は1分～5分)
4.  「保存」をクリックします。

    *   あるいは、スクリプトエディタ上部の関数選択ドロップダウンから `setupTrigger` を選択し、一度「実行」ボタン（再生アイコン）を押すことでもトリガーが設定されます（既存の同名トリガーは削除後、再作成されます）。

これでセットアップは完了です。指定したLINEグループ/ルームで、監視対象ユーザーが発言するとタイマーがセットされ、24時間以内に次の発言がなければリマインドメッセージが送信されます。

## 使い方

セットアップが完了すれば、Botは自動的に動作します。

1.  監視対象として設定されたLINEグループ/ルームで、スクリプトプロパティ `MONITORED_USER_ID` で指定されたユーザーが何かテキストメッセージを送信します。
2.  この発言をトリガーとして、Bot内部でタイマーがセットされます（ユーザーには通知されません）。
3.  もし、そのユーザーがタイマーセットから24時間以内に同じグループ/ルームで再度発言しなかった場合、Botは「リマインド」というメッセージをそのグループ/ルームに送信します。
4.  ユーザーが24時間以内に再度発言した場合、古いタイマーはクリアされ、新しい発言時刻でタイマーがリセットされます。

## カスタマイズ

### リマインダー間隔の変更

デフォルトのリマインダー間隔は24時間です。これを変更したい場合は、スクリプト内の以下の定数を変更してください。

```javascript
const REMINDER_INTERVAL_MS = 24 * 60 * 60 * 1000; // 24時間 (ミリ秒)
